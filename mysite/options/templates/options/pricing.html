{% extends "options/base.html" %}
{% load static %}

{% block title %}Pricing{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'options/css/pricing.css' %}">
{% endblock %}

{% block content %}
<div class="wrap">
    <div class="header">
        <div class="title">Pricing</div>
        <div class="muted">OVME</div>
    </div>

    <div class="card">
        <form method="post" class="form">
            {% csrf_token %}
            <div class="group col-6">
                <label>Spot (S)</label>
                <input type="number" step="any" name="spot" value="{{ spot|default:'' }}" required>
            </div>
            <div class="group col-6">
                <label>Strike (K)</label>
                <input type="number" step="any" name="strike" value="{{ strike|default:'' }}" required>
            </div>

            <div class="group col-4">
                <label>Volatility (σ)</label>
                <input type="number" step="any" name="vol" placeholder="e.g., 20 for 20%"
                    value="{{ vol|default:'20.0' }}" required>
            </div>
            <div class="group col-4">
                <label>Risk‑free rate (r)</label>
                <input type="number" step="any" name="rate" placeholder="optional, e.g., 5 for 5%"
                    value="{{ rate|default:'2.0' }}">
            </div>
            <div class="group col-4">
                <label>Dividend yield (q)</label>
                <input type="number" step="any" name="div_yield" placeholder="optional, e.g., 2 for 2%"
                    value="{{ div_yield|default:'' }}">
            </div>

            <div class="group col-6">
                <label>Days to expiry</label>
                <input type="number" step="1" min="0" name="days_to_expiry" placeholder="e.g., 30"
                    value="{{ days_to_expiry|default:'' }}">
            </div>
            <div class="group col-6">
                <label>Expiry date</label>
                <input type="date" name="expiry_date" value="{{ expiry_date|default:'' }}">
            </div>

            <div class="col-12">
                <p class="muted hint" style="margin-top: -8px;">Provide either days to expiry or an expiry date. Days to
                    expiry takes precedence.</p>
            </div>

            <div class="group col-12">
                <label>Kind</label>
                <div class="btn-group">
                    <label class="btn">
                        <input type="radio" name="kind" value="call" {% if kind == "call" or not kind %}checked{% endif %}
                            required>
                        Call
                    </label>
                    <label class="btn">
                        <input type="radio" name="kind" value="put" {% if kind == "put" %}checked{% endif %}>
                        Put
                    </label>
                </div>
            </div>
    </div>

    <div class="group col-12">
        <button type="submit" class="btn primary">Price</button>
    </div>
    </form>
</div>

{% if error %}
<div class="card err">
    <p class="error">{{ error }}</p>
</div>
{% endif %}

{% if price %}
<div class="card">
    <h3>Results</h3>
    <div class="kpi-grid">
        <div class="group">
            <label>{% if kind == "put" %}Put{% else %}Call{% endif %} option price:</label>
            <div class="kpi">{{ price }}</div>
        </div>
        <div class="group">
            <label>T (years)</label>
            <div class="kpi">{{ t_years }}</div>
        </div>
    </div>

    <h4>Inputs normalized:</h4>
    <ul>
        <li>σ = {{ vol_fmt }}</li>
        <li>r = {{ rate_fmt }}</li>
        <li>q = {{ div_fmt }}</li>
    </ul>

    <h4>Greeks:</h4>
    <div class="kpi-grid">
        {% for greek, val in greeks.items %}
        <div class="group">
            <label>{{ greek }}</label>
            <div class="kpi">{{ val }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{{ greeks|json_script:"greeks-data" }}
<script>
    // Check if greeks were embedded and log them
    const el = document.getElementById('greeks-data');
    if (el) {
      try {
        const greeks = JSON.parse(el.textContent);
        console.log('Greeks from backend:', greeks);
        // Optional: sanity check a few keys
        ['delta','gamma','vega','theta','rho'].forEach(k => {
          if (k in greeks) console.log(k, greeks[k]);
        });
      } catch (e) {
        console.error('Failed to parse greeks JSON:', e);
      }
    } else {
      console.warn('No greeks JSON found in DOM.');
    }
  </script>
{% endif %}
</div>
{% endblock %}
